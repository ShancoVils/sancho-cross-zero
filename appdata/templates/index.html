<!-- chat/templates/chat/room.html -->
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <link rel="stylesheet"  href="{% static 'style.css' %}">
</head>
<body>
    <div class = "buttons">
        <button id = "zero-change" value ="0">0</button>
        <button id = "cross-change" value ="X">X</button>
    </div>
    <div class = "rules">

    </div>
    <div class = "your-side"></div>
    
    <div class = "container">
        <div class = "field">
            <div class = "field-input" id = "elem0"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem1"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem2"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem3"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem4"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem5"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem6"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem7"></div>
        </div>
        <div class = "field">
            <div class = "field-input" id = "elem8"></div>
        </div>
    </div>


</body>
<script>

    /*
        3 - Пустое поле
        1 - Значение X
        0 - ЗНачение 0 
    */


    var array = [];
    var array_time = [];



    
    //Цвет при ходе/ожидании/не в игре
    function color_fied(user_moution){
        console.log(user_moution)
        let fields = document.querySelectorAll(".field");
        for (let i = 0 ; i < fields.length; i++) {
            if (user_moution == 0){
                console.log("locked");
                fields[i].classList.remove("unlock");
                fields[i].classList.add("lock");
            }
            else if(user_moution == 1){
                console.log("unlocked");
                fields[i].classList.remove("lock");
                fields[i].classList.add("unlock");
            }
            else if(user_moution == 2){
                fields[i].classList.remove("lock");
                fields[i].classList.remove("unlock");
            }
                
        }
    }
   


    function stupid_send(){
        chatSocket.send(JSON.stringify({
            'fields_data': array,
        }));
        console.log("отправка")
    }

    function getFieldsData(){
        list_data = document.querySelectorAll(".field-input");
        for (var i = 0 ; i < list_data.length; i++) {
            if (list_data[i].innerHTML == ""){
                array.push("");
            }
            else{
                array.push(list_data[i].innerHTML);
            }
        };
        console.log("Основной массив "+ array)
        stupid_send()
        array_time = array;
        array = [];

    }






    var user_moution;
    var user_wep;
    zero_butt = document.querySelector('#zero-change');
    zero_butt.addEventListener('click',
    function(){
        user_wep = 0;
        user_moution = 0;
        document.querySelector(".buttons").style.display = "none";
        document.querySelector(".rules").innerHTML = "<h2>"+"Первый ходит Х" +"</h2>";
        document.querySelector(".your-side").innerHTML = "<h3>Вы О</h3>";
        color_fied(user_moution)
    })



    cross_butt = document.querySelector('#cross-change');
    cross_butt.addEventListener('click' ,
    function(){
        user_wep = 1;
        user_moution = 1;
        document.querySelector(".buttons").style.display = "none";
        document.querySelector(".rules").innerHTML = "<h2>"+"Первый ходит Х" +"</h2>";
        document.querySelector(".your-side").innerHTML = "<h3>Вы Х</h3>";
        color_fied(user_moution)
    });

    //Определение поля
    window.onload = function(){
        field = document.getElementsByClassName('field-input');
        for (var i = 0 ; i < field.length; i++) {
            field[i].addEventListener('click' ,
            function(event){
                let changed_fields = document.querySelector("#"+event.target.id);
                if (user_wep == "1"){
                    changed_fields.innerText = "X";
                    getFieldsData()
                }
                else if (user_wep == "0"){
                    changed_fields.innerText = "O";
                    getFieldsData()
                }
                else{
                    alert("Выберите X или 0")
                }
                
            } , false ) ; 
        };
    };




    const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/test/'
        );
    


    console.log(chatSocket)


    chatSocket.onmessage = function(e) {
        let data = JSON.parse(e.data);
        let data_fields = data['data_fields'];
        let end_game = data['end_game_signal'];
        let result_game = data['end_game_result'];
       
        
        if (end_game !="Конец"){
            console.log("раннее"+user_moution)
            if (user_moution === 0){
                user_moution = 1;
                color_fied(user_moution)
            }
            else if(user_moution === 1){
                user_moution = 0;
                color_fied(user_moution)
            }
            console.log("получение"+user_moution)
            if (data_fields.includes("") == true) {
                for (var i = 0; i < data_fields.length; i++) {
                    field = document.getElementsByClassName('field-input');
                    for (var i = 0 ; i < field.length; i++) {
                        let changed_fields = document.querySelector("#elem"+i);
                        let elem_val = data_fields[i]
                        changed_fields.innerText = elem_val;
                    };
                    console.log(data_fields.includes(""))
                }
            }
            else{
                for (var i = 0 ; i < field.length; i++) {
                    let changed_fields = document.querySelector("#elem"+i);
                    let elem_val = data_fields[i]
                    changed_fields.innerText = elem_val;
                };
                alert("Конец ничья")
            }

        }
        else{
            for (var i = 0; i < data_fields.length; i++) {
                field = document.getElementsByClassName('field-input');
                for (var i = 0 ; i < field.length; i++) {
                    let changed_fields = document.querySelector("#elem"+i);
                    let elem_val = data_fields[i]
                    changed_fields.innerText = elem_val;
                };
                console.log(data_fields.includes(""))
            }

            console.log(result_game)
            for (let g = 0 ; g < result_game.length; g++) {
                field = document.getElementsByClassName('field-input');
                let changed_fields = document.querySelector("#elem"+result_game[g]);
                console.log(changed_fields)
                changed_fields.classList.add("win_fields");

            }


            



            user_moution = 2
            color_fied(user_moution)
            console.log("Конец победа");
            setTimeout ("alert('Игра окончена')",500);
        }



       
    }; 

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    }; 

</script>
</html>